// Hub Ã‰ducatif Modulaire - Database Schema
// See specs/001-modular-edu-hub/data-model.md for documentation

generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// ============================================
// ENUMS
// ============================================

enum ContentStatus {
  DRAFT
  PUBLISHED
}

enum ModuleProgressStatus {
  LOCKED
  AVAILABLE
  IN_PROGRESS
  COMPLETED
}

enum QuestionType {
  SINGLE_CHOICE
  MULTIPLE_CHOICE
  SHORT_TEXT
}

enum PracticeType {
  IN_GAME
  EXERCICES
  PROJET
  AUTO_EVALUATION
}

enum PracticeValidationMode {
  DECLARATIVE
  AUTOMATIC
  MANUAL
}

enum LessonMode {
  LEGACY
  SLIDES
}

enum QuizAttemptStatus {
  IN_PROGRESS
  SUBMITTED
  ABANDONED
}

// ============================================
// CONTENT MODELS
// ============================================

model Domain {
  id          String        @id @default(uuid())
  name        String        @unique @db.VarChar(100)
  description String?       @db.Text
  icon        String?       @db.VarChar(255)
  status      ContentStatus @default(DRAFT)
  order       Int           @default(0)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  deletedAt   DateTime?

  packs Pack[]

  @@index([status, order])
  @@index([deletedAt])
}

model Pack {
  id          String        @id @default(uuid())
  domainId    String
  name        String        @db.VarChar(100)
  description String?       @db.Text
  status      ContentStatus @default(DRAFT)
  order       Int           @default(0)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  deletedAt   DateTime?

  domain      Domain       @relation(fields: [domainId], references: [id])
  disciplines Discipline[]

  @@index([domainId, status, order])
  @@index([deletedAt])
}

model Discipline {
  id          String        @id @default(uuid())
  packId      String
  name        String        @db.VarChar(100)
  description String?       @db.Text
  status      ContentStatus @default(DRAFT)
  order       Int           @default(0)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  deletedAt   DateTime?

  pack    Pack     @relation(fields: [packId], references: [id])
  modules Module[]

  @@index([packId, status, order])
  @@index([deletedAt])
}

model Module {
  id            String        @id @default(uuid())
  disciplineId  String
  name          String        @db.VarChar(100)
  description   String?       @db.Text
  status        ContentStatus @default(DRAFT)
  order         Int           @default(0)
  prerequisites String[]      @default([])
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  deletedAt     DateTime?

  discipline   Discipline        @relation(fields: [disciplineId], references: [id])
  lesson       Lesson?
  progressions UserProgression[]
  notes        UserNote[]

  @@index([disciplineId, status, order])
  @@index([deletedAt])
}

model Lesson {
  id                     String                 @id @default(uuid())
  moduleId               String                 @unique
  theoryContent          String                 @db.Text
  quizThreshold          Int                    @default(70)
  practiceType           PracticeType
  practiceInstructions   String                 @db.Text
  practiceValidationMode PracticeValidationMode @default(DECLARATIVE)
  practiceTimerDuration  Int                    @default(300) // Timer duration in seconds (default 5 minutes)
  mode                   LessonMode             @default(LEGACY)

  // Quiz Randomization settings (Feature 005)
  questionsToShow        Int?                   // null = show all questions
  shuffleQuestions       Boolean                @default(true)
  shuffleAnswers         Boolean                @default(true)

  createdAt              DateTime               @default(now())
  updatedAt              DateTime               @updatedAt

  module    Module         @relation(fields: [moduleId], references: [id], onDelete: Cascade)
  questions QuizQuestion[]
  attempts  QuizAttempt[]
}

model QuizQuestion {
  id                  String       @id @default(uuid())
  lessonId            String
  questionText        String       @db.Text
  questionType        QuestionType
  options             Json?        // DEPRECATED: Use QuizOption model instead
  correctAnswer       Json         // DEPRECATED: Use QuizOption.isCorrect instead
  feedback            String?      @db.Text
  linkedTheorySection String?      @db.VarChar(255)
  order               Int          @default(0)
  createdAt           DateTime     @default(now())
  updatedAt           DateTime     @updatedAt

  lesson  Lesson       @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  choices QuizOption[] // NEW: Explicit options relation (Feature 005)

  @@index([lessonId, order])
}

// Quiz Option with stable UUID for randomization (Feature 005)
model QuizOption {
  id         String   @id @default(uuid())
  questionId String
  text       String   @db.Text
  isCorrect  Boolean  @default(false)
  order      Int      @default(0) // Legacy stable order when shuffle disabled
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  question QuizQuestion @relation(fields: [questionId], references: [id], onDelete: Cascade)

  @@index([questionId, order])
}

// ============================================
// USER MODELS
// ============================================

model User {
  id              String   @id @default(uuid())
  email           String   @unique @db.VarChar(255)
  name            String?  @db.VarChar(100)
  passwordHash    String   @db.VarChar(255)
  themePreference String   @default("mocha") @db.VarChar(20)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  progressions UserProgression[]
  notes        UserNote[]
  noteRatings  NoteRating[]
}

// ============================================
// NOTES MODELS
// ============================================

enum NoteType {
  TEXT
  LINK
}

model UserNote {
  id        String   @id @default(uuid())
  userId    String
  moduleId  String
  type      NoteType

  // For TEXT notes
  title     String?  @db.VarChar(100)
  content   String?  @db.VarChar(3000)

  // For LINK notes
  linkName        String?  @db.VarChar(255)
  linkUrl         String?  @db.VarChar(2048)
  linkPreviewTitle       String?  @db.VarChar(255)
  linkPreviewDescription String?  @db.Text
  linkPreviewImage       String?  @db.VarChar(2048)

  // Community sharing
  isPublic  Boolean  @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user    User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  module  Module       @relation(fields: [moduleId], references: [id], onDelete: Cascade)
  ratings NoteRating[]

  @@index([userId, moduleId])
  @@index([userId, createdAt(sort: Desc)])
  @@index([moduleId, isPublic])
}

// Community note ratings (5-star system)
model NoteRating {
  id        String   @id @default(uuid())
  noteId    String
  userId    String
  stars     Int      // 1-5 stars
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  note UserNote @relation(fields: [noteId], references: [id], onDelete: Cascade)
  user User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([noteId, userId])
  @@index([noteId])
}

model AdminUser {
  id           String   @id @default(uuid())
  username     String   @unique @db.VarChar(50)
  passwordHash String   @db.VarChar(255)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

// ============================================
// PROGRESSION MODELS
// ============================================

model UserProgression {
  id                  String               @id @default(uuid())
  userId              String
  moduleId            String
  status              ModuleProgressStatus @default(LOCKED)
  theoryViewedAt      DateTime?
  quizPassedAt        DateTime?
  practiceCompletedAt DateTime?
  completedAt         DateTime?
  slideState          Json?
  createdAt           DateTime             @default(now())
  updatedAt           DateTime             @updatedAt

  user     User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  module   Module        @relation(fields: [moduleId], references: [id])
  attempts QuizAttempt[]

  @@unique([userId, moduleId])
  @@index([userId, status])
}

model QuizAttempt {
  id            String            @id @default(uuid())
  progressionId String
  lessonId      String?           // Direct lesson reference (Feature 005) - nullable for backward compatibility

  // Attempt status (Feature 005)
  status        QuizAttemptStatus @default(IN_PROGRESS)
  startedAt     DateTime          @default(now())
  submittedAt   DateTime?

  // Score (computed on submit)
  score         Int?
  passed        Boolean?

  // Configuration snapshots frozen at attempt creation (Feature 005)
  questionsToShowSnapshot  Int?
  shuffleQuestionsSnapshot Boolean  @default(true)
  shuffleAnswersSnapshot   Boolean  @default(true)

  // Optional: Debug/reproducibility seed
  seed          String?           @db.VarChar(50)

  // DEPRECATED: Old JSON answers field (kept for backward compatibility)
  answers       Json?
  attemptedAt   DateTime          @default(now()) // Kept for backward compatibility

  progression UserProgression       @relation(fields: [progressionId], references: [id], onDelete: Cascade)
  lesson      Lesson?               @relation(fields: [lessonId], references: [id])
  questions   QuizAttemptQuestion[]

  @@index([progressionId, startedAt(sort: Desc)])
  @@index([lessonId, status])
}

// Tracks which questions were drawn and their display order (Feature 005)
model QuizAttemptQuestion {
  id                String    @id @default(uuid())
  attemptId         String
  questionId        String    // Reference to QuizQuestion.id

  // Display information
  position          Int       // 1-indexed display order

  // Choice mapping for MCQ (JSON: { "optionId": "A", ... })
  choiceMappingJson Json?

  // User's answer
  userAnswerJson    Json?     // optionId for SINGLE_CHOICE, array for MULTIPLE_CHOICE, string for SHORT_TEXT
  isCorrect         Boolean?

  answeredAt        DateTime?
  createdAt         DateTime  @default(now())

  attempt QuizAttempt @relation(fields: [attemptId], references: [id], onDelete: Cascade)

  @@unique([attemptId, questionId])
  @@index([attemptId, position])
}
